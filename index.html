<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="./d3.v4.js"></script>

    <title></title>

    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #svg-holder {
            margin: 30px;
            /*width: 80%;
            max-width: 80%;
            */
            height: 600px;
            border: 1px solid blue;
            /*resize: horizontal;*/
            overflow: hidden;
            /*text-align: center;*/
            padding: 5px;
        }

        svg {
            border: 1px solid red;
            width: 100%;
            height: 100%;
        }

        .fromdate {
            float: left;
        }

        .todate::before {
            content: "\00A0-\00A0";
        }
    </style>
</head>

<body>
    <div id="svg-holder">
    </div>
    <div id="bio">
        <h1>Work experience</h1>
        <ul id="work">
            <li id="job1">
                <dt>Period</dt>
                <dd class="fromdate">June 2005</dd>
                <dd class="todate">February 2007</dd>
                <dt>Position</dt>
                <dd class="type">Web Developer</dd>
                <dt>Responsibilities</dt>
                <dd class="description">Maintenance and expansion of the existing company web sites</dd>
                <dt>Employer</dt>
                <dd class="title">Some company ltd.</dd>
            </li>
            <li id="job2" class="hidden">
                <dt>Period</dt>
                <dd class="fromdate">November 2007</dd>
                <dd class="todate">February 2008</dd>
                <dt>Position</dt>
                <dd class="type">Web Developer</dd>
                <dt>Responsibilities</dt>
                <dd class="description">Development of new projects, bugfixing and securing completed projects</dd>
                <dt>Employer</dt>
                <dd class="title">Some company 2 ltd.</dd>
            </li>
            <li id="job3">
                <dt>Period</dt>
                <dd class="fromdate">February 2008</dd>
                <dd class="todate">January 2009</dd>
                <dt>Position</dt>
                <dd class="type">Backend Web Developer</dd>
                <dt>Responsibilities</dt>
                <dd class="description">blah blah</dd>
                <dt>Employer</dt>
                <dd class="title">Some company 3 ltd.</dd>
            </li>
            <li id="job4">
                <dt>Period</dt>
                <dd class="fromdate">January 2009</dd>
                <dd class="todate">November 2010</dd>
                <dt>Position</dt>
                <dd class="type">Freelance Web Developer</dd>
                <dt>Employer</dt>
                <dd class="title">Self-employed</dd>
            </li>
        </ul>
        <h1>Education</h1>
        <ul id="education">
            <li id="highschool">
                <dt>Period</dt>
                <dd class="fromdate">September 2002</dd>
                <dd class="todate">May 2007</dd>
                <dt>Type</dt>
                <dd class="type">High school</dd>
                <dt>Institution</dt>
                <dd class="title">Some high school</dd>
            </li>
            <li id="highschool_extracurricular">
                <dt>Period</dt>
                <dd class="fromdate">October 2002</dd>
                <dd class="todate">September 2003</dd>
                <dt>Type</dt>
                <dd class="type">Extracurricular activities</dd>
                <dt>Institution</dt>
                <dd class="title">Student academy for computer informatics</dd>
            </li>
            <li id="bachelors">
                <dt>Period</dt>
                <dd class="fromdate">October 2007</dd>
                <dd class="todate">May 2012</dd>
                <dt>Type</dt>
                <dd class="type">University bachelor's degree</dd>
                <dt>Institution</dt>
                <dd class="title">Some uni school</dd>
            </li>
        </ul>
        <h1>Projects and Skills</h1>
        <ul id="projects">
            <li id="some_project" data-where="highschool">
                <dt>Period</dt>
                <dd class="fromdate">October 2007</dd>
                <dd class="todate">May 2008</dd>
                <dt>Name</dt>
                <dd class="title">some name</dd>
                <dt>Description</dt>
                <dd class="description">blah blah</dd>
                <dt>Used skills</dt>
                <dd>
                    <ul class="skills">
                        <li>Pacal/Delphi</li>
                        <li>C++</li>
                        <li data-from="January 2008">PHP</li>
                    </ul>
                </dd>
            </li>
            <li id="some_project2" data-where="job1">
                <dt>Period</dt>
                <dd class="fromdate">February 2008</dd>
                <dd class="todate">December 2008</dd>
                <dt>Name</dt>
                <dd class="title">some name 2</dd>
                <dt>Description</dt>
                <dd class="description">blah blah 2</dd>
                <dt>Used skills</dt>
                <dd>
                    <ul class="skills">
                        <li>C++</li>
                        <li data-from="June 2008">PHP</li>
                    </ul>
                </dd>
            </li>
        </ul>
    </div>

    <script>
        "use strict";

        var parseDate = d3.utcParse("%B %Y");
        var fromDate = function (dateStr) {
            return d3.utcDay.offset(parseDate(dateStr), 1);
        };
        var toDate = function (dateStr) {
            return d3.utcDay.offset(d3.utcMonth.offset(parseDate(dateStr), 1), -1);
        };
        var getText = function (el, selector) {
            var subel = el.querySelector(selector);
            if (subel) {
                return subel.textContent;
            }
            return null;
        };

        var sortAndPosition = function (elements) {
            elements.sort((a, b) => a.from > b.from);

            var lastAtPos = [];
            elements.forEach(function (el) {
                var pos = 0;
                while (lastAtPos[pos] >= el.to) {
                    pos++;
                }
                lastAtPos[pos] = el.to;
                el.pos = pos;
            });
        };

        var directory = new Map();
        var skills = new Map();

        var handleSkills = function (item) {
            item.skills = [];
            item.el.querySelectorAll(".skills>li").forEach(function (sel) {
                var skillId = sel.textContent;
                var skill = {
                    used_in: item,
                    from: sel.hasAttribute("data-from") ?
                        fromDate(sel.getAttribute("data-from")) :
                        item.from,
                    to: sel.hasAttribute("data-to") ?
                        toDate(sel.getAttribute("data-to")) :
                        item.to,
                    el: sel,
                }
                item.skills.push(skill);
                if (!skills[skillId]) {
                    skills[skillId] = [];
                }
                skills[skillId].push(skill);
            });
        };

        var getItemsData = function (selector) {
            var results = [];

            document.querySelectorAll(selector).forEach(function (el) {
                var item = {
                    id: el.getAttribute("id"),
                    title: getText(el, ".title"),
                    where: el.getAttribute("data-where"),
                    type: getText(el, ".type"),
                    description: getText(el, ".description"),
                    from: fromDate(getText(el, ".fromdate")),
                    to: toDate(getText(el, ".todate")),
                    el: el,
                };

                handleSkills(item);
                results.push(item);
                if (directory.has(item.id)) {
                    console.error("Duplicate item id " + item.id);
                }
                else {
                    directory[item.id] = item;
                }
            });

            sortAndPosition(results);
            return results;
        }

        var places = getItemsData("#work>li, #education>li");
        var projects = getItemsData("#projects>li");

        skills.forEach(skill => sortAndPosition(skill));

        console.log(places);
        console.log(projects);
        console.log(skills);

        function multiFormat(date) {
            return (d3.timeYear(date) < date ? d3.timeFormat("%b") : d3.timeFormat("%Y"))(date);
        }


        var margin = { top: 35, right: 20, bottom: 25, left: 20 };

        var holder = document.getElementById("svg-holder");
        var svg = d3.select(holder).append("svg");


        var xScale = d3
            .scaleTime()
            .domain([new Date(2005, 0, 1), new Date(2017, 12, 1)]);

        var xAxis = d3.axisTop(xScale).tickFormat(multiFormat);

        svg.append("g")
            .attr("id", "timeline")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        function redraw() {
            var width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            // var height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;

            xScale.range([0, width]);

            var widthPerTick = width / xScale.ticks().length;
            // Sigmoidal between 1 (no space) and 0 (a lot of space)
            var squashed = Math.pow(1 / (1 + Math.pow(Math.E, (widthPerTick - 30) / 5)), 3);

            svg.select("g#timeline")
                .transition()
                .call(xAxis)
                .selectAll("text")
                //.style("text-anchor", "start")
                .attr("font-size", (0.5 + 0.8 * Math.pow(1 - squashed, 0.3)) + "em")
                .attr("dx", Math.sin(squashed * Math.PI / 2) * 20 + "px")
                .attr("dy", Math.sin(squashed * Math.PI / 2) * 14 - 4 + "px")
                .attr("transform", "rotate(-" + 90 * squashed + ")");
        }

        redraw();
        //window.addEventListener("resize", redraw);

        var doit;
        window.addEventListener("resize", function () {
            clearTimeout(doit);
            doit = setTimeout(redraw, 150);
        });
    </script>
</body>

</html>